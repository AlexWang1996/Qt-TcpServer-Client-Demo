
#include "tcpserver.h"


tcpserver::tcpserver(QWidget *parent, Qt::WFlags flags)
	: QMainWindow(parent, flags)
{
	ui.setupUi(this);
	editor = new QTextEdit;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
	server = new QTcpServer;	
	server->listen(QHostAddress::Any,12345);
	connect(server,SIGNAL(newConnection()),this,SLOT(acceptConnection()));	
	setCentralWidget(editor);	
	count = 0;
}

tcpserver::~tcpserver()
{

}



void tcpserver::acceptConnection()
{

	 connection = server->nextPendingConnection();
	 count++;
	 fileName = QString::number(count) + ".txt";
	 connect(connection,SIGNAL(readyRead()),this,SLOT(readClient()));
}

void tcpserver::readClient()
{
	ofstream out(fileName.toStdString().c_str());
	QObject *sender = QObject::sender(); 
	socket = qobject_cast<QTcpSocket*>(sender);
	data = socket->readAll();
	ip = socket->peerAddress().toString();
	out << QString::fromLocal8Bit(data).toStdString();
	out.close();
}

void tcpserver::writeClient()
{

	socket->write(data);
}



